<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:atom="http://www.w3.org/2005/Atom"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:xhtml="http://www.w3.org/1999/xhtml">
    <head>
        <title>dataMerger - Uploads</title>
        <xforms:model id="mod-uploads">

        	<!-- Application state -->
        	<xforms:instance id="ins-control">
        		<control xmlns="">
        			<ins-selected-upload-hrefs-is-valid>false</ins-selected-upload-hrefs-is-valid>
        		</control>
        	</xforms:instance>

        	<!-- View uploads -->
            <xforms:instance id="ins-uploads">
                <atom:feed/>
            </xforms:instance>
			<xforms:submission
				id="get-uploads"
				resource="/service/content/uploads"
				method="get"
				replace="instance"
				instance="ins-uploads">

                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the uploads.</xforms:message>
			</xforms:submission>
			<xforms:send ev:event="xforms-model-construct-done" submission="get-uploads"/>
			
			<!-- Post upload -->
        	<xforms:instance id="ins-upload">
        		<upload xmlns="">
					<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
				</upload>
        	</xforms:instance>
			<xforms:instance id="ins-new-upload">
				<upload xmlns="" 
					xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
					<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
				</upload>
			</xforms:instance>
			<xforms:submission
        		id="post-upload"
        		method="form-data-post"
        		resource="/service/content/uploads"
        		ref="instance('ins-upload')"
        		replace="none">
        		<xforms:action ev:event="xforms-submit-done">
	        		<!-- Clear out upload -->
	        		<xforms:insert nodeset="instance('ins-upload')" origin="instance('ins-new-upload')"/>
	        		<!-- Refresh Uploads -->
	        		<xforms:send submission="get-uploads"/>
        		</xforms:action>
        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while uploading.</xforms:message>
        	</xforms:submission>
			
			<!-- Select upload -->
			<xforms:instance id="ins-selected-upload-hrefs">
			    <selected-upload-hrefs xmlns=""/>
			</xforms:instance>
			<!-- TODO: Require 2 uploads to be selected. -->
			<xforms:bind nodeset="instance('ins-selected-upload-hrefs')" required="true()"/>
			<xforms:action ev:event="xxforms-invalid" ev:observer="ins-selected-upload-hrefs">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/ins-selected-upload-hrefs-is-valid">false</xforms:setvalue>
			</xforms:action>
			<xforms:action ev:event="xxforms-valid" ev:observer="ins-selected-upload-hrefs">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/ins-selected-upload-hrefs-is-valid">true</xforms:setvalue>
			</xforms:action>
			
			<!-- TODO: Attempt automated merge -->
			<xforms:instance id="ins-new-merge">
				<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
					<atom:title type="text" />
					<!-- [TODO: rel purl path] -->
					<atom:link xmlns:atom="http://www.w3.org/2005/Atom"
					rel="upload" 
					type="application/atom+xml;type=entry" href="x"/>
					<atom:link xmlns:atom="http://www.w3.org/2005/Atom"
					rel="upload" 
					type="application/atom+xml;type=entry" href="y"/>
				</atom:entry>
			</xforms:instance>
			<xforms:instance id="ins-merge">
			    <atom:entry/>
			</xforms:instance>
			<!-- TODO: Purl path for upload rel -->
			<xforms:instance id="ins-new-upload-link">
				<atom:link rel="upload" type="application/atom+xml;type=entry" href="http://localhost:8081/dataMerger/service/content/merges/2d9e3e73-16f5-465f-904e-389d53013e77"/>
			</xforms:instance>
			<xforms:submission
        		id="do-merge"
        		method="post"
        		resource="/service/content/merges"
        		ref="instance('ins-new-merge')"
        		replace="instance"
        		instance="ins-merge">
        		<xforms:action ev:event="xforms-submit-done">
	        		<xforms:message level="modal">Created the merge.</xforms:message>
				
					<!-- Insert two new links into the merge doc -->
					<xforms:insert nodeset="instance('ins-merge')" origin="instance('ins-new-upload-link')"/>
					<xforms:insert nodeset="instance('ins-merge')" origin="instance('ins-new-upload-link')"/>
				
					<!-- Copy the selected upload hrefs into the merge entry links. -->
					<!-- TODO: Purl path for upload rel -->
					<xforms:setvalue ref="instance('ins-merge')/atom:link[@rel='upload'][1]/@href" value="tokenize(instance('ins-selected-upload-hrefs'),'\s')[1]" />
					<xforms:setvalue ref="instance('ins-merge')/atom:link[@rel='upload'][2]/@href" value="tokenize(instance('ins-selected-upload-hrefs'),'\s')[2]" />
					        		
	        		<xforms:send submission="put-merge"/>
        		</xforms:action>
        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while creating the merge.</xforms:message>
        	</xforms:submission>
			<xforms:submission
        		id="put-merge"
        		method="post"
        		resource="{instance('ins-merge')/atom:link[@rel='edit']/@href}"
        		ref="instance('ins-merge')"
        		replace="instance"
        		instance="ins-merge">
        		<xforms:action ev:event="xforms-submit-done">
	        		<xforms:message level="modal">Updated the merge.</xforms:message>
        		</xforms:action>
        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while updating the merge.</xforms:message>
        	</xforms:submission>
			
        </xforms:model>
    </head>
    <body>
    <div class="page">
    	<xi:include href="../common/includes/header.xml"/>
    	<h2 class="page-title">Uploads</h2>

	
		<xforms:group ref="instance('ins-uploads')[not(exists(atom:entry))]">
    		<p>You have no uploaded files.</p>
    	</xforms:group>
    	
    	<xforms:group ref="instance('ins-uploads')[exists(atom:entry)]">
    		<div class="uploads-container">
		    	<fr:datatable>
		    		<thead>
		    			<tr>
		    				<th><!-- Column for selection checkboxes --></th>
		    				<th fr:sortable="true" fr:resizeable="false">ID</th>
		    				<th fr:sortable="true" fr:resizeable="true">Filename</th>
		    				<th fr:sortable="true" fr:resizeable="true">Uploaded</th>
		    				<th><!-- Column for download links --></th>
		    			</tr>
		    		</thead>
		    		<tbody>
		    			<xforms:repeat id="rep-uploads" nodeset="xxforms:sort(instance('ins-uploads')/atom:entry, atom:published, 'text', 'ascending')">
		    			
		    				<xxforms:variable name="upload" select="."/>
		    				<tr>
		    					<td>
		    					
						            <xforms:select appearance="full" ref="instance('ins-selected-upload-hrefs')">
						                <xforms:item>
						                    <xforms:label/>
						                    <xforms:value value="$upload/atom:link[@rel='self']/@href"/>
						                </xforms:item>
						            </xforms:select>		    					
		    					
		    					</td>
		    					<td>
		    						<!-- TODO: Generate and store the new id for uploads  -->
		    						<!-- <xforms:output value="upload:id"/> -->
		    					</td>
		    					<td>
		    						<a href="{atom:content/@src}"><xforms:output value="atom:title"/></a>
		    					</td>
		    					<td>
		    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[D01] [MNn,*-3] [Y0001]')"/>
		    					</td>
		    					<td><a href="{atom:content/@src}">Download</a></td>
		    				</tr>
		    			</xforms:repeat>
		    		</tbody>
		    	</fr:datatable>
	    	</div>
	    	
			<xforms:trigger>
				<xforms:label>Merge</xforms:label>
				<xforms:action ev:event="DOMActivate" if="instance('ins-control')/ins-selected-upload-hrefs-is-valid = 'true'">
				
					<!-- Start a new merge.  -->
					<xforms:insert nodeset="instance('ins-merge')" origin="instance('ins-new-merge')"/>

					<xforms:send submission="do-merge"/>
					
				</xforms:action>
				<xforms:action ev:event="DOMActivate" if="not(instance('ins-control')/ins-selected-upload-hrefs-is-valid = 'true')">
					<xforms:message>Please select two files to merge.</xforms:message>
				</xforms:action>
				
			</xforms:trigger>
	    </xforms:group>
	    

		<hr class="divider-space"/>
	    

	    <h3 class="field-title">New upload:</h3>
		<xforms:upload ref="instance('ins-upload')/media">
			<xforms:filename ref="@filename"/>
			<xforms:mediatype ref="@mediatype"/>
			<xxforms:size ref="@size"/>
		</xforms:upload>	    

		<xforms:trigger>
			<xforms:label>Upload</xforms:label>
			<xforms:send ev:event="DOMActivate" submission="post-upload"/>
		</xforms:trigger>


	    
	    
	</div>
	<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>
    </body>
</html>
