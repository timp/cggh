<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:xforms="http://www.w3.org/2002/xforms" 
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:at="http://purl.org/atompub/tombstones/1.0"
	xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:xs="http://www.w3.org/2001/XMLSchema">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
	<title>MalariaGEN - Data Merger</title>

	<xforms:model id="modelUploaderUploadedFiles">


			<!-- Variables for controlling the page behaviour -->
        	<xforms:instance id="instancePageState">
        		<pageState xmlns="">
        			<selectedUploadedFileSelfHrefs/>
        		</pageState>
        	</xforms:instance>

			<!-- Current Uploaded Files -->

        	<xforms:instance id="instanceUploadedFiles">
        		<atom:feed/>
        	</xforms:instance>
        	
			<xforms:submission 
				id="submissionGetUploadedFiles"
				resource="/service/content/media/uploaded"
				method="get"
				replace="instance"
				instance="instanceUploadedFiles">

               		<xforms:message ev:event="xforms-submit-error" level="modal">
                			An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the list of uploaded files.
               		</xforms:message>
               	
               	
			</xforms:submission>
        
        	<!-- Get the list of Uploaded Files after construction of the model has finished. -->
        	<xforms:send 
				ev:event="xforms-model-construct-done" 
				submission="submissionGetUploadedFiles"/>
				
				
			<!-- New Uploaded File -->

        	<xforms:instance id="instanceNewUploadedFile">
        		<upload xmlns="">
        			<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
        		</upload>
        	</xforms:instance>			
        	
        	<xforms:submission
        		id="submissionPostNewUploadedFile"
        		method="form-data-post"
        		resource="/service/content/media/uploaded"
        		ref="instance('instanceNewUploadedFile')"
        		replace="none">

				<xforms:action ev:event="xforms-submit-done">
				
					<!-- Refresh the list of files -->
					<xforms:send submission="submissionGetUploadedFiles"/> 
				
        			<!-- Empty the upload field -->
        			<xforms:insert nodeset="instance('instanceNewUploadedFile')" origin="instance('instanceEmptyUploadedFile')"/>
        			
        		</xforms:action>

        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (type:<xforms:output value="event('error-type')"/>) while uploading the new file.</xforms:message>

        	</xforms:submission>

        	<!-- this is a fresh instance to use when clearing out the main instance after each upload -->
        	<xforms:instance id="instanceEmptyUploadedFile">
        		<upload xmlns="">
        			<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
        		</upload>
        	</xforms:instance>


        	
	</xforms:model>

	<xi:include href="../common/includes/currentUserModel.xml"/>
	
</head>
<body>
	
	<h1>MalariaGEN - Data Merger</h1>
	
	<xi:include href="../common/includes/currentUserView.xml"/>

	<p>To merge files, first upload the files you want to merge, then select them from the list and press the Merge button. 
	</p>
	
	<p>Currently, only two files can be merged at one time, although a merged file can then be merged subsequently with another file, and so on.
	</p>

   	<xforms:group ref="instance('instanceUploadedFiles')[exists(atom:entry)]">
	    	
			<xforms:select ref="instance('instancePageState')/selectedUploadedFileSelfHrefs">
			
			      <xforms:label>Uploaded files:</xforms:label>
			      
			      <xforms:itemset nodeset="instance('instanceUploadedFiles')/atom:entry">
			
			             <xforms:label>
			             	<xforms:output ref="atom:title"/> 
			             	 (<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>)
			             </xforms:label>
			
			             <xforms:value ref="atom:link[@rel='self']/@href"/>
			
			      </xforms:itemset>
			
			</xforms:select>	    	

			<xforms:trigger>
	    		<xforms:label>Merge</xforms:label>
	    		<xforms:message ev:event="DOMActivate">
	    			<xforms:output ref="instance('instancePageState')/selectedUploadedFiles[1]/atom:link[@rel='self']/@href"/>
	    		</xforms:message>
	    	</xforms:trigger>

	</xforms:group>


	<xforms:group ref="instance('instanceUploadedFiles')[not(exists(atom:entry) or exists(at:deleted-entry))]">
   		<p>You currently have no uploaded files.</p>
   	</xforms:group>
	

	<h2>Upload a file</h2>

	<p>
		<xforms:upload ref="instance('instanceNewUploadedFile')/media">
			<xforms:filename ref="@filename"/>
			<xforms:mediatype ref="@mediatype"/>
			<xxforms:size ref="@size"/>
		</xforms:upload>

		<xforms:trigger>
			<xforms:label>Upload</xforms:label>
			<xforms:send ev:event="DOMActivate" submission="submissionPostNewUploadedFile"/>
		</xforms:trigger>
	</p>


	<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>

</body>
</html>